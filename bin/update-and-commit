#!/bin/bash

set -eu

cd "$( dirname "$0" )"/..

git pull origin master

echo Updating ...
make update

git add all-actions.txt

NEW_ACTIONS=$(git diff --staged | grep -e ^+.*$ | grep -v "+++" | tr -d '+' | cut -d':' -f1 | sort | uniq | tr '\n' ',' | sed 's/\(.*\),/\1./')
REMOVED_ACTIONS=$(git diff --staged | grep -e ^-.*$ | grep -v "\---" | tr -d '-' | cut -d':' -f1 | sort | uniq | tr '\n' ',' | sed 's/\(.*\),/\1./')
if [ -n "${NEW_ACTIONS}" ] && [ -n "${REMOVED_ACTIONS}" ];then 
	COMMIT_MESSAGE=$(echo "Added actions to '$NEW_ACTIONS' Removed actions from '$REMOVED_ACTIONS'")
elif [ -n "${NEW_ACTIONS}" ] && [ -z "${REMOVED_ACTIONS}" ]; then
	COMMIT_MESSAGE=$(echo "Added actions to '$NEW_ACTIONS'")
elif [ -z "${NEW_ACTIONS}" ] && [ -n "${REMOVED_ACTIONS}" ]; then
	COMMIT_MESSAGE=$(echo "Removed actions from '$NEW_ACTIONS'")
fi

if [[ $(git status -s) ]]; then
	git commit -m "$COMMIT_MESSAGE"
	git push origin master
	git diff HEAD^..HEAD
else
	echo "Nothing new..."
fi
